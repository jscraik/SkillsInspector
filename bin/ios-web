#!/usr/bin/env bash
set -euo pipefail

# bin/ios-web
# Open a route in iOS Simulator Safari and optionally capture a screenshot.

usage() {
  cat <<'EOF'
Usage:
  bin/ios-web --profile <label> --path </route> [--snap <png>] [--host <host>] [--port <port>] [--delay <seconds>] [--url <url>] [--list-profiles] [--print-resolution] [--developer-dir <path>]

Options:
  --profile   Device profile label (default: ipad_13)
  --path      Route/path to open (default: /)
  --snap      Screenshot output path (PNG). If provided, a screenshot is captured.
  --host      Host for the URL (default: localhost)
  --port      Port for the URL (default: 5173)
  --delay     Seconds to wait before screenshot (default: 2)
  --url       Full URL override (skips host/port/path)
  --list-profiles  List available simulators and exit
  --print-resolution  Print device resolution after boot
  --developer-dir    Set DEVELOPER_DIR (e.g., /Applications/Xcode-beta.app/Contents/Developer)
  -h, --help  Show help

Notes:
  - Always uses iOS Simulator and opens URLs via Safari (simctl openurl).
  - Defaults to an iPad 13-inch profile for wider layout testing; override with --profile.
  - Requires Xcode command line tools (xcrun).
EOF
}

PROFILE="ipad_13"
ROUTE_PATH="/"
HOST="localhost"
PORT="5173"
SNAP=""
DELAY="2"
URL_OVERRIDE=""
LIST_ONLY="0"
PRINT_RES="0"
DEV_DIR=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --profile) PROFILE="${2:-}"; shift 2 ;;
    --path) ROUTE_PATH="${2:-}"; shift 2 ;;
    --host) HOST="${2:-}"; shift 2 ;;
    --port) PORT="${2:-}"; shift 2 ;;
    --snap) SNAP="${2:-}"; shift 2 ;;
    --delay) DELAY="${2:-}"; shift 2 ;;
    --url) URL_OVERRIDE="${2:-}"; shift 2 ;;
    --list-profiles) LIST_ONLY="1"; shift 1 ;;
    --print-resolution) PRINT_RES="1"; shift 1 ;;
    --developer-dir) DEV_DIR="${2:-}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "ERROR: unknown option: $1"; usage; exit 2 ;;
  esac
done

if ! command -v xcrun >/dev/null 2>&1; then
  echo "ERROR: xcrun not found. Install Xcode command line tools." >&2
  exit 2
fi

if ! command -v jq >/dev/null 2>&1; then
  echo "ERROR: jq not found. Install jq to select simulator devices." >&2
  exit 2
fi

resolve_device_name() {
  case "$PROFILE" in
    ipad_13) echo "iPad Air 13-inch (M2)" ;;
    iphone_pro) echo "iPhone 15 Pro" ;;
    iphone) echo "iPhone 15" ;;
    iphone_plus) echo "iPhone 15 Plus" ;;
    iphone_se) echo "iPhone SE (3rd generation)" ;;
    ipad_pro) echo "iPad Pro (11-inch) (4th generation)" ;;
    *) echo "$PROFILE" ;;
  esac
}

if [[ -n "$DEV_DIR" ]]; then
  export DEVELOPER_DIR="$DEV_DIR"
fi

DEVICE_NAME="$(resolve_device_name)"
DEVICE_JSON="$(xcrun simctl list devices available -j)"

if [[ "$LIST_ONLY" == "1" ]]; then
  echo "Available simulators:" >&2
  echo "$DEVICE_JSON" | jq -r '.devices | to_entries | map(.value[]) | map(select(.isAvailable == true)) | .[] | "- \(.name) [\(.udid)]"'
  exit 0
fi

UDID="$(echo "$DEVICE_JSON" | jq -r --arg name "$DEVICE_NAME" '.devices | to_entries | map(.value[]) | map(select(.name == $name and .isAvailable == true)) | .[0].udid // empty')"

# Fallback order: any iPad, then any iPhone.
if [[ -z "$UDID" ]]; then
  UDID="$(echo "$DEVICE_JSON" | jq -r '.devices | to_entries | map(.value[]) | map(select(.name | startswith("iPad")) | select(.isAvailable == true)) | .[0].udid // empty')"
fi

if [[ -z "$UDID" ]]; then
  UDID="$(echo "$DEVICE_JSON" | jq -r '.devices | to_entries | map(.value[]) | map(select(.name | startswith("iPhone")) | select(.isAvailable == true)) | .[0].udid // empty')"
fi

if [[ -z "$UDID" ]]; then
  echo "ERROR: no available iOS Simulator device found." >&2
  exit 2
fi

xcrun simctl boot "$UDID" >/dev/null 2>&1 || true
xcrun simctl bootstatus "$UDID" -b >/dev/null 2>&1 || true
open -a Simulator --args -CurrentDeviceUDID "$UDID" >/dev/null 2>&1 || true

if [[ -n "$URL_OVERRIDE" ]]; then
  TARGET_URL="$URL_OVERRIDE"
else
  TARGET_URL="http://${HOST}:${PORT}${ROUTE_PATH}"
fi

# Always opens in iOS Simulator Safari
xcrun simctl openurl "$UDID" "$TARGET_URL"

if [[ "$PRINT_RES" == "1" ]]; then
  RES_JSON="$(xcrun simctl io "$UDID" enumerate | grep -A1 'Display Configuration' || true)"
  echo "Display info (best-effort):"
  echo "$RES_JSON"
fi

if [[ -n "$SNAP" ]]; then
  mkdir -p "$(dirname "$SNAP")"
  sleep "$DELAY"
  xcrun simctl io "$UDID" screenshot "$SNAP"
  echo "Screenshot saved: $SNAP"
fi

if [[ "$PRINT_RES" == "1" ]]; then
  RES_JSON="$(xcrun simctl io "$UDID" enumerate 2>/dev/null | grep -A1 'Display Configuration' || true)"
  if [[ -n "$RES_JSON" ]]; then
    echo "Display info:"
    echo "$RES_JSON"
  fi
fi
